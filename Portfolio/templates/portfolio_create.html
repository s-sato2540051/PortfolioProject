{% extends 'base.html' %}

{% block content %}
<div class="container py-4" style="max-width: 700px;">
    <h2 class="mb-3">{% if portfolio %}作品を編集{% else %}作品を投稿{% endif %}</h2>

    <form method="post" enctype="multipart/form-data" id="portfolio-form">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">タイトル</label>
            {{ form.title }}
        </div>

        <div class="mb-3">
            <label class="form-label">説明</label>
            {{ form.description }}
            {% for error in form.description.errors %}
                <small class="text-danger">{{ error }}</small>
            {% endfor %}
        </div>

        <div class="mb-3">
            <label class="form-label">サムネイル</label>
            {{ form.thumbnail }}
            {% for error in form.thumbnail.errors %}
                <small class="text-danger">{{ error }}</small>
            {% endfor %}
        </div>

        <div class="mb-3">
            <label class="form-label">追加画像（最大4枚・任意）</label>
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="image-upload-wrapper">
                        <label for="id_image1" class="image-upload-label">
                            <div class="image-preview" id="preview1">
                                {% if existing_images.0 %}
                                    <img src="{{ existing_images.0.image.url }}" alt="既存の画像">
                                {% else %}
                                    <div class="upload-icon">+</div>
                                    <span>画像を選択</span>
                                {% endif %}
                            </div>
                        </label>
                        <input type="file" id="id_image1" name="image1" accept="image/*" class="d-none image-input" data-preview="preview1">
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="image-upload-wrapper">
                        <label for="id_image2" class="image-upload-label">
                            <div class="image-preview" id="preview2">
                                {% if existing_images.1 %}
                                    <img src="{{ existing_images.1.image.url }}" alt="既存の画像">
                                {% else %}
                                    <div class="upload-icon">+</div>
                                    <span>画像を選択</span>
                                {% endif %}
                            </div>
                        </label>
                        <input type="file" id="id_image2" name="image2" accept="image/*" class="d-none image-input" data-preview="preview2">
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="image-upload-wrapper">
                        <label for="id_image3" class="image-upload-label">
                            <div class="image-preview" id="preview3">
                                {% if existing_images.2 %}
                                    <img src="{{ existing_images.2.image.url }}" alt="既存の画像">
                                {% else %}
                                    <div class="upload-icon">+</div>
                                    <span>画像を選択</span>
                                {% endif %}
                            </div>
                        </label>
                        <input type="file" id="id_image3" name="image3" accept="image/*" class="d-none image-input" data-preview="preview3">
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="image-upload-wrapper">
                        <label for="id_image4" class="image-upload-label">
                            <div class="image-preview" id="preview4">
                                {% if existing_images.3 %}
                                    <img src="{{ existing_images.3.image.url }}" alt="既存の画像">
                                {% else %}
                                    <div class="upload-icon">+</div>
                                    <span>画像を選択</span>
                                {% endif %}
                            </div>
                        </label>
                        <input type="file" id="id_image4" name="image4" accept="image/*" class="d-none image-input" data-preview="preview4">
                    </div>
                </div>
            </div>
            {% if portfolio %}
            <small class="form-text text-muted d-block mt-2">
                新しい画像を選択すると、既存の追加画像はすべて置き換えられます
            </small>
            {% endif %}
        </div>

        <div class="form-check mb-3">
            {{ form.is_public }}
            <label class="form-check-label">公開する</label>
        </div>

        <div class="mb-3">
            <label class="form-label">タグ</label>
            <select id="tag-select" multiple class="form-control" style="width: 100%;">
                {% for tag in popular_tags %}
                <option value="{{ tag.name }}">{{ tag.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" id="tag-input" name="tags" value="">
            <small class="form-text text-muted d-block mt-1">
                既存のタグから選択、または新しいタグを入力できます
            </small>
            
            {% if popular_tags %}
            <div class="mt-2">
                <small class="text-muted">人気のタグ:</small>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    {% for tag in popular_tags|slice:":15" %}
                    <button type="button" class="btn btn-sm btn-outline-secondary tag-btn" data-tag="{{ tag.name }}">
                        {{ tag.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label class="form-label">共同制作者（任意）</label>
            <div id="coauthors-container"></div>
            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-coauthor-btn">
                + 共同制作者を追加
            </button>
            <input type="hidden" id="coauthors-data" name="coauthors_data" value="[]">
        </div>

        <div class="mb-3">
            <label class="form-label">外部リンク（任意）</label>
            {{ form.external_link }}
        </div>

        <button type="submit" class="btn btn-primary w-100">{% if portfolio %}更新{% else %}投稿{% endif %}</button>
        {% if portfolio %}
        <a href="{% url 'portfolio_detail' portfolio.pk %}" class="btn btn-outline-secondary w-100 mt-2">キャンセル</a>
        {% endif %}
    </form>
</div>

<style>
.select2-container--default .select2-selection--multiple {
    min-height: 40px;
    border-radius: 0.375rem;
}
.select2-container--default .select2-selection--multiple .select2-search__field {
    height: 30px;
    margin-top: 5px;    
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    padding: 3px 23px;
    font-size: 90%;
    border-radius: 4px;
    margin: 3px;
}

/* Select2のユーザー検索結果の画像表示 */
.select2-container--default .select2-results__option--highlighted[aria-selected] img {
    border: 1px solid #fff; 
}


.tag-btn {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    margin: 2px;
}

.coauthor-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
}

.coauthor-type-selector {
    margin-bottom: 10px;
}

/* 画像アップロードのスタイル */
.image-upload-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%; /* 1:1の正方形 */
}

.image-upload-label {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
    margin: 0;
}

.image-preview {
    width: 100%;
    height: 100%;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    transition: all 0.3s;
    overflow: hidden;
}

.image-preview:hover {
    border-color: #0d6efd;
    background: #e7f1ff;
}

.image-preview i,
.image-preview .upload-icon {
    font-size: 2rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 300;
}

.image-preview span {
    font-size: 0.85rem;
    color: #6c757d;
}

.image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.image-preview.has-image {
    border-style: solid;
    border-color: #28a745;
}

.image-preview.has-image:hover {
    border-color: #218838;
}
</style>

<script>
function formatUserResult(user) {
    if (!user.id) {
        return user.text;
    }
    const profileImage = user.profile_image || '/static/Portfolio/img/default_user.png';
    const $container = $(
        `<span class="d-flex align-items-center">
            <img src="${profileImage}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
            <span>${user.text}</span>
        </span>`
    );
    return $container;
}

function formatUserSelection(user) {
    if (!user.id) {
        return user.text; 
    }
    const profileImage = user.profile_image || '/static/Portfolio/img/default_user.png';
    const $container = $(
        `<span class="d-flex align-items-center">
            <img src="${profileImage}" class="rounded-circle me-1" style="width: 20px; height: 20px; object-fit: cover;">
            <span>${user.text}</span>
        </span>`
    );
    return $container;
}


function initializeUserSearch(selectElement) {
    selectElement.select2({
        placeholder: "ユーザー名を入力して検索",
        allowClear: true,
        width: '100%',
        ajax: {
            url: "{% url 'user_search_api' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    term: params.term 
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        templateResult: formatUserResult,
        templateSelection: formatUserSelection, 
        minimumInputLength: 1
    });
    
    selectElement.on('select2:select', function(e) {
        const data = e.params.data;
        $(this).closest('.coauthor-item').find('.internal-user-id').val(data.id);
        updateCoauthorsData();
    });
    
    selectElement.on('select2:unselect', function(e) {
        $(this).closest('.coauthor-item').find('.internal-user-id').val('');
        updateCoauthorsData();
    });
    
    selectElement.on('select2:open', function() {
        $('.select2-container--open .select2-search__field').focus();
    });
}

$(document).ready(function() {
    

    $('#tag-select').select2({
        tags: true,
        tokenSeparators: [',', ' '],
        placeholder: "タグを入力または選択してください",
        width: "100%",
        multiple: true,
        allowClear: true,
        
        ajax: {
            url: "{% url 'tag_search_api' %}", 
            dataType: 'json',
            delay: 250, 
            data: function (params) {
                return {
                    term: params.term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        
        language: {
            noResults: function() {
                return "既存のタグが見つかりません。新しいタグとして追加できます";
            },
            searching: function() {
                return "タグを検索中...";
            }
        },
        minimumInputLength: 1 
    });
    
    {% if portfolio %}
    const existingTags = [{% for tag in portfolio.tags.all %}"{{ tag.name }}"{% if not forloop.last %},{% endif %}{% endfor %}];
    if (existingTags.length > 0) {
        $('#tag-select').val(existingTags).trigger('change');
    }
    {% endif %}
    
    $('#tag-select').on('change', function() {
        var selectedValues = $(this).val() || [];
        var tagsString = selectedValues.join(',');
        $('#tag-input').val(tagsString);
        
        $('.tag-btn').each(function() {
            var tagName = $(this).data('tag');
            if (selectedValues.includes(tagName)) {
                $(this).addClass('active');
            } else {
                $(this).removeClass('active');
            }
        });
    });
    
    $('.tag-btn').on('click', function(e) {
        e.preventDefault();
        var tagName = $(this).data('tag');
        var currentValues = $('#tag-select').val() || [];
        
        if (currentValues.includes(tagName)) {
            currentValues = currentValues.filter(function(value) {
                return value !== tagName;
            });
        } else {
            currentValues.push(tagName);
        }
        
        $('#tag-select').val(currentValues).trigger('change');
    });
    
    $('#portfolio-form').on('submit', function() {
        var selectedValues = $('#tag-select').val() || [];
        var tagsString = selectedValues.join(',');
        $('#tag-input').val(tagsString);
        return true;
    });

    let coauthorIndex = 0;
    
    {% if existing_coauthors %}
    const existingCoauthors = {{ existing_coauthors|safe }};
    existingCoauthors.forEach(coauthor => {
        addCoauthorField(coauthor);
    });
    {% endif %}
    
    function updateCoauthorsData() {
        const coauthors = [];
        $('.coauthor-item').each(function() {
            const type = $(this).find('.coauthor-type').val();
            if (type === 'internal') {
                const userId = $(this).find('.internal-user-id').val().trim();
                if (userId) {
                    coauthors.push({ type: 'internal', user_id: userId }); 
                }
            } else if (type === 'external') {
                const name = $(this).find('.external-name').val().trim();
                const url = $(this).find('.external-url').val().trim();
                if (name) {
                    coauthors.push({ type: 'external', name: name, url: url });
                }
            }
        });
        $('#coauthors-data').val(JSON.stringify(coauthors));
    }

    function addCoauthorField(existingData = null) {
        const index = coauthorIndex++;
        const html = `
            <div class="coauthor-item" data-index="${index}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="coauthor-type-selector flex-grow-1">
                        <select class="form-select form-select-sm coauthor-type" data-index="${index}">
                            <option value="">選択してください</option>
                            <option value="internal" ${existingData && existingData.type === 'internal' ? 'selected' : ''}>このサービスのユーザー</option>
                            <option value="external" ${existingData && existingData.type === 'external' ? 'selected' : ''}>外部アカウント（Twitter/YouTube等）</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger remove-coauthor ms-2" data-index="${index}">×</button>
                </div>
                <div class="coauthor-fields" data-index="${index}"></div>
            </div>
        `;
        $('#coauthors-container').append(html);
        
        if (existingData) {
            setTimeout(() => {
                $(`.coauthor-type[data-index="${index}"]`).trigger('change');
                if (existingData.type === 'internal') {
                    const selectElement = $(`.internal-user-select[data-index="${index}"]`);
                    const newOption = new Option(existingData.username, existingData.user_id, true, true);
                    selectElement.append(newOption).trigger('change');
                    $(`.internal-user-id`).last().val(existingData.user_id);
                } else if (existingData.type === 'external') {
                    $(`.external-name`).last().val(existingData.name);
                    $(`.external-url`).last().val(existingData.url || '');
                }
                updateCoauthorsData();
            }, 100);
        }
    }


    $(document).on('change', '.coauthor-type', function() {
        const index = $(this).data('index');
        const type = $(this).val();
        const fieldsContainer = $(`.coauthor-fields[data-index="${index}"]`);
        
        fieldsContainer.find('.internal-user-select').select2('destroy');
        
        if (type === 'internal') {
            fieldsContainer.html(`
                <select class="form-control internal-user-select" data-index="${index}"></select>
                <input type="hidden" class="internal-user-id" value=""> 
            `);
            const selectElement = $(`.internal-user-select[data-index="${index}"]`);
            initializeUserSearch(selectElement);
            selectElement.select2('open'); 

        } else if (type === 'external') {
            fieldsContainer.html(`
                <div class="row g-2">
                    <div class="col-5">
                        <input type="text" class="form-control external-name" placeholder="名前">
                    </div>
                    <div class="col-7">
                        <input type="url" class="form-control external-url" placeholder="URL（任意）">
                    </div>
                </div>
            `);
        } else {
            fieldsContainer.html('');
        }
        updateCoauthorsData();
    });

    $(document).on('input', '.external-name, .external-url', function() {
        updateCoauthorsData();
    });

    $(document).on('click', '.remove-coauthor', function() {
        const index = $(this).data('index');
        $(`.coauthor-item[data-index="${index}"]`).remove();
        updateCoauthorsData();
    });

    $('#add-coauthor-btn').on('click', function() {
        addCoauthorField();
    });

    $('.image-input').on('change', function() {
        const input = this;
        const previewId = $(this).data('preview');
        const preview = $('#' + previewId);
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.html(`<img src="${e.target.result}" alt="プレビュー">`);
                preview.addClass('has-image');
            };
            
            reader.readAsDataURL(input.files[0]);
        }
    });
});
</script>

{% endblock %}